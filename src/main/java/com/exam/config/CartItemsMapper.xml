<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.exam.config.CartItemsMapper">


	<!-- cartItems, Products 조인 -->
	<resultMap type="CartItemsDTO" id="cartItemsProductsJoin">
		<id property="productId" column="product_id"/>
		<result property="cartItemId" column="cart_item_id"/>
		<result property="cartId" column="cart_id"/>
        <result property="amount" column="amount"/>
        <association property="product" javaType="com.exam.dto.ProductsDTO">
        	<result property="productId" column="product_id"/>
        	<result property="categoryId" column="category_id"/>
	        <result property="discountId" column="discount_id"/>
	        <result property="productName" column="product_name"/>
	        <result property="productPrice" column="product_price"/>
	        <result property="productImage" column="product_image"/>
	        <result property="productDescription" column="product_description"/>
	        <result property="unit" column="unit"/>
	        <result property="value" column="value"/>
	        <result property="productQr" column="product_qr"/>
	        <result property="productCode" column="product_code"/>
	        <result property="createDate" column="create_date"/>
        </association>     
	</resultMap>
	
	<select id="findcartItemsProducts" resultMap="cartItemsProductsJoin" parameterType="int">
		select * 
		from cart_items ci join products p on ci.product_id = p.product_id 
		where cart_id = #{cartId}
		order by cart_item_id
	</select>
    <!-- ProductsDTO의 Result Map 정의 -->
    <resultMap id="ProductsResultMap" type="com.exam.dto.ProductsDTO">
        <id property="productId" column="product_id"/>
        <result property="categoryId" column="category_id"/>
        <result property="discountId" column="discount_id"/>
        <result property="productName" column="product_name"/>
        <result property="productPrice" column="product_price"/>
        <result property="productImage" column="product_image"/>
        <result property="productDescription" column="product_description"/>
        <result property="unit" column="unit"/>
        <result property="value" column="value"/>
        <result property="productQr" column="product_qr"/>
        <result property="productCode" column="product_code"/>
        <result property="createdDate" column="created_date"/>
    </resultMap>

    <!-- CartItemsDTO의 Result Map 정의 -->
    <resultMap id="CartItemsResultMap" type="CartItemsDTO">
        <id property="cartItemId" column="cart_item_id"/>
        <result property="productId" column="product_id"/>
        <result property="quantity" column="quantity"/>
        <association property="product" javaType="com.exam.dto.ProductsDTO" column="product_id" select="findProductById"/>
    </resultMap>

    <!-- CartDTO의 Result Map 정의 -->
    <resultMap id="CartResultMap" type="CartsDTO">
        <id property="cartId" column="cart_id"/>
        <result property="userId" column="user_id"/>
        <collection property="cartItems" ofType="CartItemsDTO" resultMap="CartItemsResultMap"/>
    </resultMap>

    <!-- 장바구니 조회 -->
    <select id="findItemsByCartId" parameterType="int" resultMap="CartItemsResultMap">
        SELECT * FROM cart_items WHERE cart_id = #{cartId}
    </select>

    <!-- 상품 ID로 상품 조회 -->
    <select id="findProductById" parameterType="int" resultMap="ProductsResultMap">
        SELECT * FROM products WHERE product_id = #{productId}
    </select>

    <!-- 모든 상품 조회 -->
    <select id="findAllProducts" resultMap="ProductsResultMap">
        SELECT * FROM products
    </select>

    <!-- 장바구니 추가 -->
    <insert id="addCart" parameterType="CartsDTO" useGeneratedKeys="true" keyProperty="cartId">
        INSERT INTO carts (user_id)
        VALUES (#{userId})
    </insert>

    <!-- 장바구니 항목 추가 -->
    <insert id="addCartItem" parameterType="CartItemsDTO">
        INSERT INTO cartitems (cart_id, product_id, quantity)
        VALUES (#{cartId}, #{productId}, #{quantity})
    </insert>

    <!-- 장바구니 항목 수정 -->
    <update id="updateCartItem" parameterType="CartItemsDTO">
        UPDATE cartitems
        SET quantity = #{quantity}
        WHERE cart_item_id = #{cartItemId}
    </update>

    <!-- 장바구니 항목 삭제 -->
    <delete id="deleteCartItem" parameterType="int">
        DELETE FROM cartitems WHERE cart_item_id = #{cartItemId}
    </delete>

</mapper>
